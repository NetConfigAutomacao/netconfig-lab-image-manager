# This file is part of NetConfig Lab Image Manager.
#
# NetConfig Lab Image Manager is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# NetConfig Lab Image Manager is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with NetConfig Lab Image Manager.  If not, see <https://www.gnu.org/licenses/>.

events {}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        listen 80;
        listen [::]:80;

        # Sem limite de tamanho de upload
        client_max_body_size 0;

        root /usr/share/nginx/html;

        location / {
            try_files $uri /index.html;
        }

        location /static/ {
            alias /usr/share/nginx/html/static/;
        }

        location /static/topoviewer/ {
            alias /usr/share/nginx/html/static/topoviewer/;
            types {
                application/javascript js mjs;
                text/css css;
                application/json json;
                image/svg+xml svg;
                font/woff2 woff2;
                font/woff woff;
                font/ttf ttf;
                image/png png;
                image/jpeg jpeg jpg;
            }
            default_type application/octet-stream;
            add_header Cache-Control "no-cache";
        }

        # Proxy para o backend Flask
        location /api/ {
            # Permite requisições longas (ex.: install de imagens grandes)
            proxy_connect_timeout 300s;
            proxy_send_timeout 3600s;
            proxy_read_timeout 3600s;

            proxy_request_buffering off;
            proxy_buffering off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_pass http://api:8080/;
        }
    }
}
